---
title: "Issue 3"
author: "Group 5"
date: "9/5/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(tidyverse)
library(knitr)
library(kableExtra)
```

### Data cleaning (following Joachim Gassens file)

Read the data. 

```{r readData}
insol_raw <- read_csv(
  "../raw_data/insolvency_filings_de_julaug2020.csv",
  col_types = cols()
)
orbis_raw <- read_csv(
  "../raw_data/orbis_wrds_de.csv",
  col_types = cols()
)
```

Delet duplicates in insolvency data

```{r deleteDups}
insol_de <- insol_raw %>% unique()
```

Check for missing values in insolvency data.

```{r displayNAs}
na_vals <- insol_de %>%
  summarise_all(list( ~ sum(is.na(.))))

nas_df <- tibble(
  Variable = names(insol_de),
  `NA count` = t(na_vals)
)

kable(nas_df) %>% 
  kable_styling(full_width = FALSE)
```


Two variables contain missing values. Take a look at it:

```{r ShowNAObs}
insol_de %>%
  filter(is.na(name_debtor)) %>%
  kable() %>%
  kable_styling()
```

Delete one observation. 

```{r FinalizeSample}
insol_de <- insol_de %>%
  filter(!is.na(name_debtor))
```


### Identifying observations in insolvency data

It is always important to know the primary keys that identify an observation. Most of the time, you will have an expectation which these are from your knowledge about the data domain. Here, this is not that simple. Let's first see whether each firm name is uniquely linked to a court and court file number (court file numbers are assigned by each court individually, so they overlap across courts).

```{r NamesCourtFileNumber}
unique_firms <- insol_de %>%
  distinct(name_debtor, .keep_all = TRUE)

unique_firms %>%
  group_by(insolvency_court, court_file_number) %>%
  filter(n() > 1) %>%
  arrange(insolvency_court, court_file_number, name_debtor) %>%
  kable() %>%
  kable_styling()
```

This does not look as if, in principle, firms have unique court file numbers but that the names of firms are written inconsistently. Oh the joys of real life data. We are not fixing this for the time being as we have no clear way no how to pick the "right" firm name. So, can we assume that each court file number has only one filing by subject on a given day? 

```{r FilingsBySubjectAndDay}
insol_de %>%
  group_by(date, insolvency_court, court_file_number, subject) %>%
  filter(n() > 1) %>%
  arrange(date, insolvency_court, court_file_number, subject) %>%
  kable() %>%
  kable_styling()
```

Even this does not seem to be the case maybe because of inconsistencies in the firm names and firm domiciles. These data items seem to be very messy. This implies that only all variable together identify an observation. OK. Last step: Sorting (a habit of mine, not strictly necessary) and then we can finally prepare some descriptives.

```{r Sortung}
insol_de <- insol_de %>%
  arrange(
    date, insolvency_court, court_file_number, 
    subject, name_debtor, domicile_debtor
  )
```

```{r}

```

